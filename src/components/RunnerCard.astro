---
import { Icon } from "astro-icon/components";

export interface Props {
    id: number;
    name: string;
    distance: "10K" | "15K";
    registrationTime: string;
    timeAgo: number; // minutes
    avatar: string;
    location: string;
    gender: string;
}

const { id, name, distance, registrationTime, timeAgo, avatar, location, gender } = Astro.props;
---

<div 
    class="group relative overflow-hidden rounded-2xl cursor-pointer transform transition-all duration-300 hover:scale-[1.02] bg-gradient-to-br from-primary-800/80 to-primary-500/80 backdrop-blur-sm border-1 border-white/10 hover:border-secondary-500/30 hover:shadow-lg hover:shadow-secondary-500/10"
    data-runner-id={id}
    data-runner-name={name}
    data-runner-distance={distance}
    data-runner-location={location}
    data-runner-avatar={avatar}
    data-runner-gender={gender}
>
    <!-- Image Section -->
    <div class="relative aspect-square overflow-hidden">
        <img
            src={avatar}
            alt={name}
            class="w-full h-full object-cover transition-all duration-500 group-hover:scale-110"
            loading="lazy"
        />
        
        <!-- Gradient overlay -->
        <div class="absolute inset-0 bg-gradient-to-t from-black/40 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
        
        <!-- Distance Badge -->
        <div class={`absolute top-3 right-3 px-3 py-1 rounded-full text-xs font-bold shadow-lg ${
            distance === "15K" 
                ? "bg-gradient-to-r from-primary-500 to-primary-600 text-white" 
                : "bg-gradient-to-r from-orange-500 to-orange-600 text-white"
        }`}>
            <span class="text-white font-nova md:text-sm text-lg">
                {distance}
            </span>
        </div>
        
        <!-- Share Button -->
        <button
            class="runner-share-btn absolute top-3 left-3 w-8 h-8 bg-gradient-to-br from-secondary-500 to-secondary-600 rounded-full flex items-center justify-center shadow-lg transform transition-all duration-300 hover:scale-110 hover:shadow-xl hover:shadow-secondary-500/25 z-10"
            title="Compartir corredor"
            type="button"
        >
            <Icon name="tabler/download" class="w-4 h-4 text-white" />
        </button>
        
        <!-- Recent Registration Badge -->
        {timeAgo <= 60 && (
            <div class="absolute top-3 left-12 w-8 h-8 bg-gradient-to-br from-green-500 to-green-600 rounded-full flex items-center justify-center shadow-lg transform transition-all duration-300 group-hover:scale-110">
                <Icon name="tabler/clock" class="w-4 h-4 text-white" />
            </div>
        )}
    </div>
    
    <!-- Content Section -->
    <div class="p-4">
        <!-- Runner Name -->
        <h3 class="text-white font-semibold md:text-xl text-3xl leading-tight mb-2 group-hover:text-secondary-300 transition-colors duration-300">
            {name}
        </h3>
        
        <!-- Welcome Message -->
        <p class="text-slate-300 text-lg flex items-center mb-3">
            <!-- <Icon name="tabler/check" class="w-3 h-3 mr-1 flex-shrink-0" /> -->
            <span class="truncate">{gender === 'Masculino' ? 'Bienvenido' : 'Bienvenida'} a la carrera</span>
        </p>
        
        <!-- Registration Status -->
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                <span class="text-green-400 text-sm font-medium">
                    {gender === 'Masculino' ? 'Inscrito' : 'Inscrita'} 
                </span>
            </div>
            <span class="text-slate-300 text-sm">
                {registrationTime}
            </span>
        </div>
    </div>
    
    <!-- Hover Glow Effect -->
    <div class="absolute inset-0 bg-gradient-to-br from-secondary-500/0 to-secondary-500/0 group-hover:from-secondary-500/5 group-hover:to-transparent rounded-2xl transition-all duration-500 pointer-events-none"></div>
</div>

<!-- Share Modal -->
<div id="share-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 opacity-0 invisible transition-all duration-300">
    <div class="bg-white/10 backdrop-blur-lg border border-white/20 rounded-2xl p-6 max-w-sm w-full transform scale-95 transition-all duration-300">
        <!-- Modal Header -->
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-white font-semibold text-lg">Compartir corredor</h3>
            <button id="close-share-modal" class="text-white/70 hover:text-white transition-colors p-1" type="button">
                <Icon name="tabler/x" class="w-5 h-5" />
            </button>
        </div>
        
        <!-- Runner Info Preview -->
        <!-- <div id="runner-preview" class="bg-white/5 rounded-xl p-4 mb-6 border border-white/10">
            <div class="flex items-center space-x-3">
                <img id="preview-avatar" src="" alt="" class="w-12 h-12 rounded-full object-cover" />
                <div>
                    <h4 id="preview-name" class="text-white font-medium"></h4>
                    <p id="preview-info" class="text-slate-300 text-sm"></p>
                </div>
            </div>
        </div> -->
        
        <!-- Generated Image Preview -->
        <div id="image-preview-container" class="hidden mb-6">
            <h4 class="text-white font-medium text-sm mb-3 text-center">Vista previa de la imagen generada:</h4>
            <div class="bg-white/5 rounded-xl p-4 border border-white/10">
                <div id="image-preview" class="w-32 h-60 mx-auto overflow-hidden rounded-lg  flex items-center justify-center">
                    <div class="text-center text-white/60">
                        <Icon name="tabler/medal" class="w-8 h-8 mx-auto mb-2 opacity-50" />
                        <p class="text-xs">La imagen se generará aquí</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Share Options -->
        <div class="space-y-3">
            <!-- Instagram Stories -->
            <button id="share-instagram" class="w-full flex items-center space-x-3 p-3 bg-gradient-to-r from-pink-500 to-purple-600 rounded-xl text-white font-medium hover:shadow-lg hover:shadow-pink-500/25 transition-all duration-300 transform hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed" type="button">
                <Icon name="tabler/instagram-logo" class="w-5 h-5" />
                <span>Instagram Stories</span>
            </button>
            
            <!-- WhatsApp -->
            <button id="share-whatsapp" class="w-full flex items-center space-x-3 p-3 bg-gradient-to-r from-green-500 to-green-600 rounded-xl text-white font-medium hover:shadow-lg hover:shadow-green-500/25 transition-all duration-300 transform hover:scale-[1.02]" type="button">
                <Icon name="tabler/whatsapp-logo" class="w-5 h-5" />
                <span>WhatsApp</span>
            </button>
            
            <!-- Download Image -->
            <button id="download-image" class="w-full flex items-center space-x-3 p-3 bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl text-white font-medium hover:shadow-lg hover:shadow-blue-500/25 transition-all duration-300 transform hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed" type="button">
                <Icon name="tabler/download" class="w-5 h-5" />
                <span>Descargar Imagen</span>
            </button>
        </div>
        
        <!-- Loading State -->
        <div id="loading-state" class="hidden text-center py-4">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto mb-2"></div>
            <p class="text-white text-sm">Procesando imagen...</p>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toast-container" class="fixed bottom-4 right-4 z-60 space-y-2"></div>

<style>
    /* Enhanced glassmorphism effects */
    .backdrop-blur-sm {
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
    }
    
    .backdrop-blur-lg {
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
    }
    
    /* Smooth image loading */
    img {
        image-rendering: -webkit-optimize-contrast;
        image-rendering: crisp-edges;
    }
    
    /* Pulse animation */
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    .animate-pulse {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    /* Spin animation for loading */
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .animate-spin {
        animation: spin 1s linear infinite;
    }
    
    /* Modal animations */
    #share-modal.show {
        opacity: 1;
        visibility: visible;
    }
    
    #share-modal.show > div {
        transform: scale(1);
    }
</style>

<script>
    // Types
    interface RunnerData {
        id: number;
        name: string;
        distance: string;
        location: string;
        avatar: string;
    }

    interface ToastOptions {
        type?: 'success' | 'error' | 'info';
        duration?: number;
    }

    // Toast utility
    class ToastManager {
        private container: HTMLElement;

        constructor() {
            this.container = document.getElementById('toast-container')!;
        }

        show(message: string, options: ToastOptions = {}): void {
            const { type = 'info', duration = 3000 } = options;
            
            const toast = document.createElement('div');
            toast.className = `
                transform translate-x-full transition-all duration-300 ease-out
                bg-white/10 backdrop-blur-lg border border-white/20 rounded-xl 
                px-4 py-3 text-white text-sm shadow-lg max-w-xs
                ${type === 'success' ? 'border-green-500/30 bg-green-500/10' : ''}
                ${type === 'error' ? 'border-red-500/30 bg-red-500/10' : ''}
            `;
            
            toast.textContent = message;
            this.container.appendChild(toast);
            
            // Animate in
            requestAnimationFrame(() => {
                toast.classList.remove('translate-x-full');
            });
            
            // Remove after duration
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    if (this.container.contains(toast)) {
                        this.container.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }
    }

    // Image capture utility
    class ImageCaptureService {
        private static async loadHtml2Canvas(): Promise<void> {
            if (typeof (window as any).html2canvas !== 'undefined') return;
            
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                script.onload = () => resolve();
                script.onerror = () => reject(new Error('Failed to load html2canvas'));
                document.head.appendChild(script);
            });
        }

        static async captureElement(element: HTMLElement): Promise<Blob> {
            await this.loadHtml2Canvas();
            
            const html2canvas = (window as any).html2canvas;
            if (!html2canvas) {
                throw new Error('html2canvas not available');
            }

            return this.createStoryCanvas(element);
        }

        private static async createStoryCanvas(element: HTMLElement): Promise<Blob> {
            const html2canvas = (window as any).html2canvas;
            
            // Hide share button during capture
            const shareBtn = element.querySelector('.runner-share-btn') as HTMLElement;
            const originalDisplay = shareBtn?.style.display || '';
            if (shareBtn) shareBtn.style.display = 'none';

            try {
                // Wait for images to load
                const images = element.querySelectorAll('img');
                await Promise.all(Array.from(images).map(img => {
                    if (img.complete) return Promise.resolve();
                    return new Promise<void>((resolve, reject) => {
                        const timeout = setTimeout(() => reject(new Error('Image load timeout')), 5000);
                        img.onload = () => {
                            clearTimeout(timeout);
                            resolve();
                        };
                        img.onerror = () => {
                            clearTimeout(timeout);
                            reject(new Error('Image load failed'));
                        };
                    });
                }));

                // Create a temporary container for story format
                const storyContainer = document.createElement('div');
                storyContainer.style.cssText = `
                    position: fixed;
                    top: -9999px;
                    left: -9999px;
                    width: 1080px;
                    height: 1920px;
                    background: linear-gradient(135deg, #0b75b9 0%, #c9d436 100%);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 60px 40px;
                    box-sizing: border-box;
                `;

                // Clone the card element
                const cardClone = element.cloneNode(true) as HTMLElement;
                cardClone.style.cssText = `
                    width: 100%;
                    max-width: 480px;
                    height: auto;
                    transform: scale(1.2);
                    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
                    border-radius: 24px;
                `;

                // Fix text positioning and sizes in the clone
                const nameElement = cardClone.querySelector('h3');
                if (nameElement) {
                    nameElement.style.cssText = `
                        color: white;
                        font-weight: 600;
                        font-size: 28px;
                        line-height: 1.2;
                        margin-bottom: 12px;
                        text-align: left;
                        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
                    `;
                }

                const locationElement = cardClone.querySelector('p');
                if (locationElement) {
                    locationElement.style.cssText = `
                        color: rgb(203, 213, 225);
                        font-size: 16px;
                        display: flex;
                        align-items: center;
                        margin-bottom: 16px;
                        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
                    `;
                }

                const statusContainer = cardClone.querySelector('.flex.items-center.justify-between');
                if (statusContainer) {
                    (statusContainer as HTMLElement).style.cssText = `
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        font-size: 16px;
                    `;
                    
                    const statusText = statusContainer.querySelector('.text-green-400');
                    if (statusText) {
                        (statusText as HTMLElement).style.textShadow = '0 1px 2px rgba(0, 0, 0, 0.3)';
                    }
                    
                    const timeText = statusContainer.querySelector('.text-slate-300');
                    if (timeText) {
                        (timeText as HTMLElement).style.textShadow = '0 1px 2px rgba(0, 0, 0, 0.3)';
                    }
                }

                // Remove the share button from clone
                const clonedShareBtn = cardClone.querySelector('.runner-share-btn');
                if (clonedShareBtn) {
                    clonedShareBtn.remove();
                }

                // Welcome title background
                const welcomeTitleBackground = document.createElement('div');
                welcomeTitleBackground.style.cssText = `
                    position: absolute;
                    top: 50px;
                    left: 50%;
                    transform: translateX(-50%);
                    text-align: center;
                    color: white;
                `;
                welcomeTitleBackground.innerHTML = `
                    <div style="font-size: 80px; font-family: nova, sans-serif; font-weight: bold; margin-bottom: 2px; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);">Bienvenido</div>
                    <div style="font-size: 100px; font-family: nova, sans-serif; font-weight: bold; margin-bottom: 8px; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);">Carlos</div>
                `;

                storyContainer.appendChild(welcomeTitleBackground);

                // Add the image of the runner
                const runnerImageDiv = document.createElement('div');
                const imageSrc = cardClone.querySelector('img')?.src || '';
                runnerImageDiv.style.cssText = `
                    position: absolute;
                    top: 400px;
                    left: 50%;
                    transform: translateX(-50%);
                    width: 900px;
                    height: auto;
                    max-height: 900px;
                    min-height: 1000px;
                    background-image: url('${imageSrc}');
                    background-size: cover;
                    background-position: top;
                    border-radius: 24px;
                `;

                storyContainer.appendChild(runnerImageDiv);

                // Add branding
                const brandingDiv = document.createElement('div');
                brandingDiv.style.cssText = `
                    position: absolute;
                    bottom: 100px;
                    left: 50%;
                    transform: translateX(-50%);
                    text-align: center;
                    color: white;
                `;
                brandingDiv.innerHTML = `
                    <div style="font-size: 100px; font-family: nova, sans-serif; font-weight: bold; margin-bottom: 2px; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);">15K</div>
                    <div style="font-size: 80px; font-family: nova, sans-serif; font-weight: bold; margin-bottom: 8px; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);">URRAO</div>
                    <div style="font-size: 30px; opacity: 0.9; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);">Cuerpo y mente</div>
                `;

                // storyContainer.appendChild(cardClone);
                storyContainer.appendChild(brandingDiv);
                document.body.appendChild(storyContainer);

                // Capture the story container
                const canvas = await html2canvas(storyContainer, {
                    backgroundColor: null,
                    scale: 1,
                    useCORS: true,
                    allowTaint: false,
                    logging: false,
                    width: 1080,
                    height: 1920
                });

                // Remove temporary container
                document.body.removeChild(storyContainer);

                // Convert to blob
                return new Promise<Blob>((resolve, reject) => {
                    canvas.toBlob((blob: Blob | null) => {
                        if (blob) {
                            resolve(blob);
                        } else {
                            reject(new Error('Failed to create blob'));
                        }
                    }, 'image/png', 1.0);
                });
            } finally {
                // Restore share button
                if (shareBtn) shareBtn.style.display = originalDisplay;
            }
        }
    }

    // Main RunnerCard class
    class RunnerCardManager {
        private toast: ToastManager;
        private modal: HTMLElement;
        private currentRunnerData: RunnerData | null = null;

        constructor() {
            this.toast = new ToastManager();
            this.modal = document.getElementById('share-modal')!;
            this.init();
        }

        private init(): void {
            this.bindEvents();
        }

        private bindEvents(): void {
            // Card click events (excluding share button)
            document.querySelectorAll('[data-runner-id]').forEach(card => {
                card.addEventListener('click', (e) => {
                    if (!(e.target as Element).closest('.runner-share-btn')) {
                        this.handleCardClick(card as HTMLElement);
                    }
                });
            });

            // Share button events
            document.querySelectorAll('.runner-share-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const card = btn.closest('[data-runner-id]') as HTMLElement;
                    this.openShareModal(card);
                });
            });

            // Modal events
            this.bindModalEvents();
        }

        private bindModalEvents(): void {
            // Close button
            const closeBtn = document.getElementById('close-share-modal');
            closeBtn?.addEventListener('click', () => this.closeModal());

            // Click outside to close
            this.modal.addEventListener('click', (e) => {
                if (e.target === this.modal) this.closeModal();
            });

            // Share platform buttons
            document.getElementById('share-instagram')?.addEventListener('click', () => this.shareToInstagram());
            document.getElementById('share-whatsapp')?.addEventListener('click', () => this.shareToWhatsApp());
            document.getElementById('download-image')?.addEventListener('click', () => this.downloadImage());

            // ESC key to close
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && this.modal.classList.contains('show')) {
                    this.closeModal();
                }
            });
        }

        private extractRunnerData(card: HTMLElement): RunnerData {
            return {
                id: parseInt(card.dataset.runnerId || '0'),
                name: card.dataset.runnerName || '',
                distance: card.dataset.runnerDistance || '',
                location: card.dataset.runnerLocation || '',
                avatar: card.dataset.runnerAvatar || ''
            };
        }

        private updateModalPreview(data: RunnerData): void {
            const avatar = document.getElementById('preview-avatar') as HTMLImageElement;
            // const name = document.getElementById('preview-name')!;
            // const info = document.getElementById('preview-info')!;

            if (avatar) avatar.src = data.avatar;
            // name.textContent = data.name;
            // info.textContent = `${data.distance} • ${data.location}`;
        }

        private async openShareModal(card: HTMLElement): Promise<void> {
            this.currentRunnerData = this.extractRunnerData(card);
            this.updateModalPreview(this.currentRunnerData);
            
            // Show the modal
            this.modal.classList.add('show');
            document.body.style.overflow = 'hidden';
            
            // Generate and show image preview
            await this.generateImagePreview(card);
        }

        private closeModal(): void {
            this.modal.classList.remove('show');
            document.body.style.overflow = '';
            this.currentRunnerData = null;
            
            // Hide the image preview
            const previewContainer = document.getElementById('image-preview-container');
            if (previewContainer) {
                previewContainer.classList.add('hidden');
            }
        }

        private async shareToInstagram(): Promise<void> {
            if (!this.currentRunnerData) return;

            try {
                this.setLoadingState(true);
                const card = document.querySelector(`[data-runner-id="${this.currentRunnerData.id}"]`) as HTMLElement;
                const imageBlob = await ImageCaptureService.captureElement(card);
                
                await this.shareImageBlob(imageBlob, 'Instagram Stories');
                this.closeModal();
            } catch (error) {
                console.error('Instagram share error:', error);
                this.toast.show('Error al compartir en Instagram', { type: 'error' });
            } finally {
                this.setLoadingState(false);
            }
        }

        private shareToWhatsApp(): void {
            if (!this.currentRunnerData) return;

            const text = `🏃‍♂️ ¡Mira este corredor!\n\n${this.currentRunnerData.name} se inscribió para la carrera de ${this.currentRunnerData.distance} desde ${this.currentRunnerData.location}.\n\n¡Únete a la 15KURRAO! 🏁`;
            const url = encodeURIComponent(window.location.href);
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(text)}%20${url}`;
            
            window.open(whatsappUrl, '_blank');
            this.closeModal();
            this.toast.show('Compartiendo en WhatsApp...', { type: 'success' });
        }

        private async downloadImage(): Promise<void> {
            if (!this.currentRunnerData) return;

            try {
                this.setLoadingState(true);
                const card = document.querySelector(`[data-runner-id="${this.currentRunnerData.id}"]`) as HTMLElement;
                const imageBlob = await ImageCaptureService.captureElement(card);
                
                this.downloadBlob(imageBlob, `${this.currentRunnerData.name}-15kurrao-card.png`);
                this.toast.show('¡Imagen descargada exitosamente!', { type: 'success' });
                this.closeModal();
            } catch (error) {
                console.error('Download error:', error);
                this.toast.show('Error al descargar la imagen', { type: 'error' });
            } finally {
                this.setLoadingState(false);
            }
        }

        private async shareImageBlob(blob: Blob, platform: string): Promise<void> {
            const file = new File([blob], 'runner-card.png', { type: 'image/png' });
            
            if (navigator.share && navigator.canShare?.({ files: [file] })) {
                await navigator.share({
                    title: `${this.currentRunnerData!.name} - 15KURRAO`,
                    text: `🏃‍♂️ ¡Mira este corredor! ${this.currentRunnerData!.name} se inscribió para la carrera de ${this.currentRunnerData!.distance} desde ${this.currentRunnerData!.location}. ¡Únete a la 15KURRAO! 🏁`,
                    files: [file]
                });
            } else {
                this.downloadBlob(blob, `${this.currentRunnerData!.name}-15kurrao-card.png`);
                this.toast.show(`Imagen descargada. Compártela en ${platform} manualmente.`, { type: 'info' });
            }
        }

        private downloadBlob(blob: Blob, filename: string): void {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        private setLoadingState(loading: boolean): void {
            const loadingEl = document.getElementById('loading-state');
            const buttons = this.modal.querySelectorAll('button:not(#close-share-modal)');
            
            if (loading) {
                loadingEl?.classList.remove('hidden');
                buttons.forEach(btn => btn.setAttribute('disabled', 'true'));
            } else {
                loadingEl?.classList.add('hidden');
                buttons.forEach(btn => btn.removeAttribute('disabled'));
            }
        }

        private async generateImagePreview(card: HTMLElement): Promise<void> {
            try {
                // Show loading state in preview
                const previewContainer = document.getElementById('image-preview-container');
                const imagePreview = document.getElementById('image-preview');
                
                if (previewContainer && imagePreview) {
                    previewContainer.classList.remove('hidden');
                    imagePreview.innerHTML = `
                        <div class="text-center text-white/60">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto mb-2"></div>
                            <p class="text-sm">Generando vista previa...</p>
                        </div>
                    `;
                }

                // Generate the image
                const imageBlob = await ImageCaptureService.captureElement(card);
                
                // Create preview image
                const previewUrl = URL.createObjectURL(imageBlob);
                
                if (imagePreview) {
                    imagePreview.innerHTML = `
                        <img src="${previewUrl}" alt="Vista previa de la imagen generada" class="w-full h-full object-contain rounded-lg" />
                    `;
                }
                
                // Clean up the URL after a delay to ensure the image loads
                setTimeout(() => {
                    URL.revokeObjectURL(previewUrl);
                }, 5000);
                
            } catch (error) {
                console.error('Error generating preview:', error);
                const imagePreview = document.getElementById('image-preview');
                if (imagePreview) {
                    imagePreview.innerHTML = `
                        <div class="text-center text-white/60">
                            <Icon name="tabler/alert-triangle" class="w-8 h-8 mx-auto mb-2 text-yellow-400" />
                            <p class="text-sm">Error al generar la vista previa</p>
                        </div>
                    `;
                }
            }
        }

        private handleCardClick(card: HTMLElement): void {
            const data = this.extractRunnerData(card);
            console.log('Card clicked:', data);
            this.toast.show(`Ver detalles de ${data.name}`);
        }
    }

    // Initialize when DOM is ready
    function initializeRunnerCards(): void {
        new RunnerCardManager();
    }

    // Auto-initialize
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeRunnerCards);
    } else {
        initializeRunnerCards();
    }
</script>