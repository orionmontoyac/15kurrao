---
import { Icon } from "astro-icon/components";

export interface Props {
    id: number;
    name: string;
    distance: "10K" | "15K";
    registrationTime: string;
    timeAgo: number; // minutes
    avatar: string;
    location: string;
}

const { id, name, distance, registrationTime, timeAgo, avatar, location } = Astro.props;
---

<div 
    class="group relative overflow-hidden rounded-2xl cursor-pointer transform transition-all duration-300 hover:scale-[1.02] bg-gradient-to-br from-white/10 to-white/5 backdrop-blur-sm border border-white/10 hover:border-secondary-500/30 hover:shadow-lg hover:shadow-secondary-500/10"
    data-runner-id={id}
>
    <!-- Image Section (Half of the card) -->
    <div class="relative aspect-square overflow-hidden">
        <img
            src={avatar}
            alt={name}
            class="w-full h-full object-cover transition-all duration-500 group-hover:scale-110"
            loading="lazy"
        />
        
        <!-- Gradient overlay -->
        <div class="absolute inset-0 bg-gradient-to-t from-black/40 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
        
        <!-- Distance Badge (Top Right) -->
        <div class={`absolute top-3 right-3 px-3 py-1 rounded-full text-xs font-bold shadow-lg ${
            distance === "15K" 
                ? "bg-gradient-to-r from-primary-500 to-primary-600 text-white" 
                : "bg-gradient-to-r from-orange-500 to-orange-600 text-white"
        }`}>
            <h1 class="text-white font-nova md:text-sm text-lg">
                {distance}
            </h1>
        </div>
        
        <!-- Share Button (Top Left) - Always Visible -->
        <button
            class="absolute top-3 left-3 w-8 h-8 bg-gradient-to-br from-secondary-500 to-secondary-600 rounded-full flex items-center justify-center shadow-lg transform transition-all duration-300 hover:scale-110 hover:shadow-xl hover:shadow-secondary-500/25 z-10"
            data-share-runner
            data-runner-name={name}
            data-runner-distance={distance}
            data-runner-location={location}
            data-runner-avatar={avatar}
            title="Compartir corredor"
        >
            <Icon name="tabler/share" class="w-4 h-4 text-white" />
        </button>
        
        <!-- Recent Registration Badge (Top Left - moved down when share button is visible) -->
        {timeAgo <= 60 && (
            <div
                class="absolute top-3 left-12 w-8 h-8 bg-gradient-to-br from-green-500 to-green-600 rounded-full flex items-center justify-center shadow-lg transform transition-all duration-300 group-hover:scale-110"
            >
                <Icon name="tabler/clock" class="w-4 h-4 text-white" />
            </div>
        )}
        
        <!-- Online indicator (Bottom Right of image) -->
        <!-- <div class="absolute bottom-3 right-3 w-4 h-4 bg-green-500 rounded-full border-2 border-white shadow-lg"></div> -->
    </div>
    
    <!-- Content Section (Bottom Half) -->
    <div class="p-4">
        <!-- Runner Name -->
        <h3 class="text-white font-semibold md:text-lg text-3xl eading-tight mb-2 group-hover:text-secondary-300 transition-colors duration-300">
            {name}
        </h3>
        
        <!-- Location -->
        <p class="text-slate-300 text-sm flex items-center mb-3">
            <Icon name="tabler/map-pin" class="w-3 h-3 mr-1 flex-shrink-0" />
            <span class="truncate">{location}</span>
        </p>
        
        <!-- Registration Status -->
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                <span class="text-green-400 text-sm font-medium">
                    Inscrito
                </span>
            </div>
            <span class="text-slate-300 text-sm">
                {registrationTime}
            </span>
        </div>
    </div>
    
    <!-- Hover Glow Effect -->
    <div class="absolute inset-0 bg-gradient-to-br from-secondary-500/0 to-secondary-500/0 group-hover:from-secondary-500/5 group-hover:to-transparent rounded-2xl transition-all duration-500 pointer-events-none"></div>
</div>

<!-- Share Modal -->
<div id="share-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white/10 backdrop-blur-lg border border-white/20 rounded-2xl p-6 max-w-sm w-full transform scale-95 opacity-0 transition-all duration-300">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-white font-semibold text-lg">Compartir corredor</h3>
            <button id="close-share-modal" class="text-white/70 hover:text-white transition-colors">
                <Icon name="tabler/x" class="w-5 h-5" />
            </button>
        </div>
        
        <div class="space-y-3">
            <!-- Instagram Stories -->
            <button id="share-instagram" class="w-full flex items-center space-x-3 p-3 bg-gradient-to-r from-pink-500 to-purple-600 rounded-xl text-white font-medium hover:shadow-lg hover:shadow-pink-500/25 transition-all duration-300 transform hover:scale-[1.02]">
                <Icon name="tabler/instagram-logo" class="w-5 h-5" />
                <span>Instagram Stories</span>
            </button>
            
            <!-- WhatsApp -->
            <button id="share-whatsapp" class="w-full flex items-center space-x-3 p-3 bg-gradient-to-r from-green-500 to-green-600 rounded-xl text-white font-medium hover:shadow-lg hover:shadow-green-500/25 transition-all duration-300 transform hover:scale-[1.02]">
                <Icon name="tabler/whatsapp-logo" class="w-5 h-5" />
                <span>WhatsApp</span>
            </button>
            
            <!-- Download Image -->
            <button id="download-image" class="w-full flex items-center space-x-3 p-3 bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl text-white font-medium hover:shadow-lg hover:shadow-blue-500/25 transition-all duration-300 transform hover:scale-[1.02]">
                <Icon name="tabler/circle-arrow-up" class="w-5 h-5" />
                <span>Descargar Imagen</span>
            </button>
        </div>
    </div>
</div>

<style>
    /* Enhanced glassmorphism effects */
    .backdrop-blur-sm {
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
    }
    
    /* Smooth image loading */
    img {
        image-rendering: -webkit-optimize-contrast;
        image-rendering: crisp-edges;
    }
    
    /* Pulse animation for online indicators */
    @keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.5;
        }
    }
    
    .animate-pulse {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    /* Card hover animations */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .runner-card-animate {
        animation: fadeInUp 0.6s ease-out forwards;
    }
</style>

<script>
    // Import html2canvas from CDN
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
    script.onload = () => {
        console.log('html2canvas loaded successfully');
        initializeRunnerCard();
    };
    document.head.appendChild(script);

    // Runner Card interactions
    class RunnerCard {
        constructor() {
            this.init();
        }
        
        init() {
            this.bindEvents();
        }
        
        bindEvents() {
            // Add click handler for the card (excluding share button)
            document.querySelectorAll('[data-runner-id]').forEach((card) => {
                card.addEventListener('click', (e) => {
                    // Don't trigger card click if clicking on share button
                    if (e.target.closest('[data-share-runner]')) {
                        return;
                    }
                    e.preventDefault();
                    this.handleCardClick(card);
                });
            });
            
            // Add share button handlers
            this.bindShareEvents();
        }
        
        bindShareEvents() {
            // Share button click
            document.querySelectorAll('[data-share-runner]').forEach((button) => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Share button clicked');
                    this.openShareModal(button);
                });
            });
            
            // Modal close button
            const closeBtn = document.getElementById('close-share-modal');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => this.closeShareModal());
            }
            
            // Close modal when clicking outside
            const modal = document.getElementById('share-modal');
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        this.closeShareModal();
                    }
                });
            }
            
            // Share platform buttons
            this.bindSharePlatformEvents();
        }
        
        bindSharePlatformEvents() {
            // Instagram Stories
            const instagramBtn = document.getElementById('share-instagram');
            if (instagramBtn) {
                instagramBtn.addEventListener('click', () => {
                    console.log('Instagram share clicked');
                    this.shareToInstagram();
                });
            }
            
            // WhatsApp
            const whatsappBtn = document.getElementById('share-whatsapp');
            if (whatsappBtn) {
                whatsappBtn.addEventListener('click', () => this.shareToWhatsApp());
            }
            
            // Download Image
            const downloadBtn = document.getElementById('download-image');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', () => {
                    console.log('Download image clicked');
                    this.downloadStoryImage();
                });
            }
        }
        
        openShareModal(button) {
            const modal = document.getElementById('share-modal');
            if (!modal) return;
            
            console.log('Opening share modal');
            
            // Get runner data from button
            const runnerName = button.getAttribute('data-runner-name') || '';
            const runnerDistance = button.getAttribute('data-runner-distance') || '';
            const runnerLocation = button.getAttribute('data-runner-location') || '';
            const runnerAvatar = button.getAttribute('data-runner-avatar') || '';
            
            // Store data for sharing
            window.currentRunnerData = {
                name: runnerName,
                distance: runnerDistance,
                location: runnerLocation,
                avatar: runnerAvatar
            };
            
            // Show modal with animation
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }
        
        closeShareModal() {
            const modal = document.getElementById('share-modal');
            if (!modal) return;
            
            modal.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }
        
        async shareToInstagram() {
            const data = window.currentRunnerData;
            if (!data) {
                console.error('No runner data found');
                return;
            }
            
            this.showToast('Capturando imagen del corredor...');
            
            try {
                const imageBlob = await this.captureRunnerCard(data);
                console.log('Image captured successfully');
                
                // Try to share via Web Share API if available
                if (navigator.share && navigator.canShare) {
                    const file = new File([imageBlob], 'runner-card.png', { type: 'image/png' });
                    if (navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            title: `${data.name} - 15KURRAO`,
                            text: `🏃‍♂️ ¡Mira este corredor! ${data.name} se inscribió para la carrera de ${data.distance} desde ${data.location}. ¡Únete a la 15KURRAO! 🏁`,
                            files: [file]
                        });
                    } else {
                        // Fallback: Download the image
                        this.downloadImageBlob(imageBlob, `${data.name}-15kurrao-card.png`);
                        this.showToast('Imagen descargada. Compártela en Instagram Stories manualmente.');
                    }
                } else {
                    // Fallback: Download the image
                    this.downloadImageBlob(imageBlob, `${data.name}-15kurrao-card.png`);
                    this.showToast('Imagen descargada. Compártela en Instagram Stories manualmente.');
                }
                
                this.closeShareModal();
            } catch (error) {
                console.error('Error capturing runner card:', error);
                this.showToast('Error al capturar la imagen. Inténtalo de nuevo.');
            }
        }
        
        shareToWhatsApp() {
            const data = window.currentRunnerData;
            if (!data) return;
            
            const text = `🏃‍♂️ ¡Mira este corredor!\n\n${data.name} se inscribió para la carrera de ${data.distance} desde ${data.location}.\n\n¡Únete a la 15KURRAO! 🏁`;
            const url = encodeURIComponent(window.location.href);
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(text)}%20${url}`;
            
            window.open(whatsappUrl, '_blank');
            this.closeShareModal();
            this.showToast('Compartiendo en WhatsApp...');
        }
        
        async downloadStoryImage() {
            const data = window.currentRunnerData;
            if (!data) {
                console.error('No runner data found');
                return;
            }
            
            this.showToast('Capturando imagen...');
            
            try {
                const imageBlob = await this.captureRunnerCard(data);
                this.downloadImageBlob(imageBlob, `${data.name}-15kurrao-card.png`);
                this.showToast('¡Imagen descargada exitosamente!');
                this.closeShareModal();
            } catch (error) {
                console.error('Error capturing runner card:', error);
                this.showToast('Error al capturar la imagen. Inténtalo de nuevo.');
            }
        }
        
        downloadImageBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        async captureRunnerCard(data) {
            console.log('Starting capture process for:', data.name);
            
            // Check if html2canvas is available
            if (typeof html2canvas === 'undefined') {
                throw new Error('html2canvas library not loaded');
            }
            
            // Find the runner card element using the stored runner data
            const runnerCards = document.querySelectorAll('[data-runner-id]');
            let targetCard = null;
            
            // Find the card that matches the current runner data
            for (const card of runnerCards) {
                const cardName = card.querySelector('h3')?.textContent?.trim();
                if (cardName === data.name) {
                    targetCard = card;
                    break;
                }
            }
            
            if (!targetCard) {
                console.error('Runner card not found for:', data.name);
                throw new Error('Runner card not found');
            }
            
            console.log('Found target card:', targetCard);
            
            // Temporarily hide the share button to get a clean capture
            const shareButton = targetCard.querySelector('[data-share-runner]');
            const originalDisplay = shareButton ? shareButton.style.display : '';
            if (shareButton) {
                shareButton.style.display = 'none';
            }
            
            try {
                console.log('Capturing with html2canvas...');
                
                // Wait for images to load
                const images = targetCard.querySelectorAll('img');
                await Promise.all(Array.from(images).map(img => {
                    if (img.complete) return Promise.resolve();
                    return new Promise((resolve, reject) => {
                        img.onload = resolve;
                        img.onerror = reject;
                        // Add timeout to prevent hanging
                        setTimeout(reject, 5000);
                    });
                }));
                
                // Use html2canvas to capture the runner card
                const canvas = await html2canvas(targetCard, {
                    backgroundColor: null, // Transparent background
                    scale: 2, // Higher resolution for better quality
                    useCORS: true,
                    allowTaint: false,
                    logging: true, // Enable logging for debugging
                    width: targetCard.offsetWidth,
                    height: targetCard.offsetHeight,
                    onclone: (clonedDoc) => {
                        // Ensure styles are preserved in the cloned document
                        const clonedCard = clonedDoc.querySelector(`[data-runner-id="${targetCard.getAttribute('data-runner-id')}"]`);
                        if (clonedCard) {
                            const clonedShareButton = clonedCard.querySelector('[data-share-runner]');
                            if (clonedShareButton) {
                                clonedShareButton.style.display = 'none';
                            }
                        }
                    }
                });
                
                console.log('Canvas created successfully:', canvas.width, 'x', canvas.height);
                
                // Convert canvas to blob
                return new Promise((resolve, reject) => {
                    canvas.toBlob((blob) => {
                        if (blob) {
                            console.log('Blob created successfully:', blob.size, 'bytes');
                            resolve(blob);
                        } else {
                            reject(new Error('Failed to create blob from canvas'));
                        }
                    }, 'image/png', 0.95);
                });
                
            } finally {
                // Restore the share button
                if (shareButton) {
                    shareButton.style.display = originalDisplay;
                }
            }
        }
        
        handleCardClick(card) {
            const runnerId = card.getAttribute('data-runner-id');
            const runnerName = card.querySelector('h3')?.textContent || 'corredor';
            
            // You can implement a modal or navigation here
            console.log(`Clicked runner ${runnerId}: ${runnerName}`);
            
            // Show a toast notification
            this.showToast(`Ver detalles de ${runnerName}`);
        }
        
        showToast(message) {
            // Create a simple toast notification
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 right-4 bg-white/10 backdrop-blur-lg border border-white/20 rounded-xl px-4 py-3 text-white text-sm z-50 transform translate-y-full transition-transform duration-300';
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-y-full');
            }, 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.classList.add('translate-y-full');
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
    }
    
    // Initialize function
    function initializeRunnerCard() {
        console.log('Initializing RunnerCard...');
        new RunnerCard();
    }
    
    // Initialize when DOM is loaded (fallback if script is already executed)
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof html2canvas !== 'undefined') {
                initializeRunnerCard();
            }
        });
    } else {
        // DOM is already loaded
        if (typeof html2canvas !== 'undefined') {
            initializeRunnerCard();
        }
    }
</script>